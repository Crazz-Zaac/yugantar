FROM python:3.12-slim-bullseye

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    tesseract-ocr \
    tesseract-ocr-eng \
    libpq-dev \
    libgl1 \
    libglib2.0-0 \
    curl && \
    rm -rf /var/lib/apt/lists/*

# Install Poetry
RUN curl -sSL https://install.python-poetry.org | python3 -
ENV PATH="/root/.local/bin:$PATH"

WORKDIR /app

# Copy dependency files
COPY backend/pyproject.toml backend/poetry.lock* /app/

# Install dependencies globally (no venv needed in container)
RUN poetry config virtualenvs.create false && \
    poetry install --no-interaction --no-ansi

# Copy entrypoint OUTSIDE of /app so volume won't overwrite it
COPY backend/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Don't copy source code - it will be mounted as volume in dev

EXPOSE 8000

ENTRYPOINT ["/entrypoint.sh"]
CMD ["--reload"]